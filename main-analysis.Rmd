---
title: "Change of manager effect in football"
author: "Pascal Albisser"
date: "2023-02-17"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "hide"
---

```{r, message = FALSE, echo = FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(fixest)
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Whenever a football team performs badly oftentimes the first measure taken is the sacking of the teams manager. In the swiss football league the FC Sion and his president Christian Constantin are known for their rigorous sacking of managers for not delivering the desired results. Recently (27.02.2023) they suspended their manager Fabio Celestini after six games without win as [blick.ch](https://www.blick.ch/sport/fussball/superleague/celestini-beurlaubt-cc-uebernimmt-beim-fc-sion-brennts-mal-wieder-lichterloh-id18355581.html) reported.

I personally feel this is not a very effective measure. My impression is that it may have an effect in the first one or two games but in the long turn it does not. So why not have a look at some data to scrutinize if changing the manager of a bad performing team has an effect on its position in the league?

# Data Source

To examine this question I take a look at a [football dataset](https://www.kaggle.com/datasets/davidcariboo/player-scores) from kaggle.com. It consists of 60'535 observations of football games scraped from the [www.transfermarkt.co.uk](https://www.transfermarkt.co.uk/). The dataset includes many values among them the name of the current manager. This allows us detect changes of the managers which is our treatment in this case.

```{r loading-data}
games <- read.csv("./data/kaggle_transfermarkt/games.csv") %>% 
  mutate(date = as.Date(date))
summary(games)
```
## Preprocessing

Although the data contain all necessary values it is of inconvenient form four my analysis. I want to have one team per row for example. But the dataset has two in each, namely the home and away team per match. This requires some preprocessing of the data.

```{r}

# seperate observations for home...
games_home <- games %>% 
  rename(team_id = home_club_id,
         team_name = club_home_name,
         team_goals = home_club_goals,
         opponent_goals = away_club_goals,
         team_position = home_club_position,
         team_manager = home_club_manager_name
         ) %>% 
  select(c("game_id", "team_name", "competition_type", "date", "competition_id", "season", "round", "team_id", "team_goals", "opponent_goals", "team_position", "team_manager", "stadium", "attendance", "referee", "url")) %>%
  mutate(where = "Home") %>% 
  arrange(team_id)

# ...and away teams
games_away <- games %>% 
  rename(team_id = away_club_id,
         team_name = club_away_name,
         team_goals = away_club_goals,
         opponent_goals = home_club_goals,
         team_position = away_club_position,
         team_manager = away_club_manager_name
         ) %>% 
  select(c("game_id", "team_name", "competition_type", "date", "competition_id", "season", "round", "team_id", "team_goals", "opponent_goals", "team_position", "team_manager", "stadium", "attendance", "referee", "url")) %>%
  mutate(where = "Away") %>% 
  arrange(team_id)

# combine both
df_games <- rbind(games_home, games_away)

df_games <- df_games %>% 
  arrange(game_id)

# Some 1314 observations have missing values for managers - drop these
df_games <- df_games %>% 
  filter(team_manager != "")

head(df_games)

```


## Construct Variables

I add a column indicating manager changes in comparison to the last game played to detect a treatment. 

```{r}
df_games <- df_games %>% 
  arrange(date) %>% 
  group_by(team_id) %>% 
  mutate(team_manager_last_game = lag(team_manager)) %>% 
  mutate(manager_change = team_manager_last_game != team_manager) %>% 
  ungroup()

df_games %>% 
  filter(team_manager != team_manager_last_game)
```

## Take spanish league as subset

The dataset contains teams of different football leagues. Some teams take part of other competitions as the Champions League or the domestic cup as well. For reasons of simplicity I restrict my analysis on the games and teams of spanish league (La Liga). This provides us with an enclosed system to look at and more importantly with a constant indicator of performance: the rank on the league table.  

```{r}
spanish_league <- df_games %>% 
  filter(competition_id == "ES1") %>% 
  mutate(round_n = as.numeric(sub(" .*", "", round))) %>% 
  group_by(team_id) %>%
  mutate(games_since_last_change = with(rle(manager_change), sequence(lengths)) * !manager_change) %>%
  ungroup() %>% 
  arrange(desc(date)) %>% 
  group_by(team_id) %>% 
  mutate(games_to_change = with(rle(manager_change), sequence(lengths)) * !manager_change) %>%
  ungroup() %>% 
  arrange(date)
```

## Overview

In order to get a feeling of the dynamics of the data I plot here all games per team with indicators where a manager change happened (red).

```{r}

spanish_league %>% 
  arrange(team_id, date) %>% 
  #select(date, team_id, team_manager, team_manager_last_game, games_since_last_change, games_to_change, round_n) %>% 
  ggplot(mapping = aes(y = factor(team_name), x = date)) +
    geom_point(shape = "|") +
    geom_point(data = . %>% filter(manager_change), shape = 18, colour = "red", size = 3) +
    labs(title = "Games & manager changes in La Liga per team", subtitle = "Seasons 2011 - 2022", x = "", y = "team")
  
```

This plot already shows one particular difficulty of this analysis: The treatments happen at different points in time. So 

```{r}

spanish_league_ordered <- spanish_league %>% 
  arrange(team_id, date)
  
spanish_league_ordered %>%
  group_by(team_id) %>% 
  mutate(treatment = paste(team_manager, "->", team_manager_last_game)) %>% 
  mutate(before_treatment = lag(manager_change, 5L)) %>%
  mutate(treatment = lag(treatment, 5L)) %>% 
  ungroup() %>% 
  filter(manager_change | before_treatment) %>% 
  select(date, team_id, team_manager, team_manager_last_game, before_treatment, manager_change, round_n, treatment)
  
```

# The Difference-in-Differences approach

Look for similiar sequences, but without change (treatment)
Do the same procedure for treatment example to get same easy follow procedure


```{r}
df_treatments <- spanish_league_ordered %>% 
  group_by(team_id) %>% 
  mutate(position_start = lag(team_position, 4L, order_by = team_id)) %>% 
  mutate(position_before = lag(team_position, 1L, order_by = team_id)) %>% 
  mutate(position_after = lead(team_position, 2L, order_by = team_id)) %>% 
  mutate(position_start_rel = 0) %>% 
  mutate(position_before_rel = position_start - position_before) %>% 
  mutate(position_after_rel = position_start - position_after) %>% 
  ungroup() %>% 
  filter(manager_change) %>% 
  select(game_id, team_id, date, position_start, position_before, position_after, round_n, season, team_name, team_manager, team_manager_last_game, position_start_rel, position_before_rel, position_after_rel) %>% 
  filter(position_start <= position_before) %>%  # only treatments with decrease in position before 
  mutate(group_id = row_number())

df_treatments <- df_treatments %>% 
  pivot_longer(
    cols = starts_with("position_"),
    names_to = "t",
    values_to = "position"
  ) %>% 
  mutate(t = factor(t, levels = c("position_start", "position_before", "position_after", "position_start_rel", "position_before_rel", "position_after_rel")))

df_treatments
  
```

```{r, warning = FALSE}
df_treatments %>%   
  filter(grepl('_rel', t)) %>% 
  ggplot(mapping = aes(x = t, y = position, group = group_id, colour = team_name)) +
    geom_point() +
    geom_line() +
    geom_smooth(formula = y ~ x, method = "loess", mapping = aes(group = NA)) +
    labs(title = "Change of position, pre and post manager change")
```




```{r}

df_control <- spanish_league_ordered %>%
  group_by(team_id) %>% 
  mutate(position_start = lag(team_position, 4L, order_by = team_id)) %>% 
  mutate(position_before = lag(team_position, 1L, order_by = team_id)) %>% 
  mutate(position_after = lead(team_position, 2L, order_by = team_id)) %>% 
  mutate(position_start_rel = 0) %>% 
  mutate(position_before_rel = position_start - position_before) %>% 
  mutate(position_after_rel = position_start - position_after) %>% 
  mutate(same_manager = lag(team_manager, 4L, order_by = team_id) == team_manager & team_manager == lead(team_manager, 2L, order_by = team_id)) #--> need to check if same manager in period

df_control <- df_control %>%
  filter(position_before_rel <= 0) %>%
  filter(same_manager) %>%
  mutate(round_distance = abs(round_n - lead(round_n))) %>%
  filter(round_distance > 3) %>%
  filter(round_n > 5 & round_n < 34) %>%
  select(game_id, team_id, date, position_start, position_before, position_after, round_n, season, team_name, team_manager, team_manager_last_game, position_start_rel, position_before_rel, position_after_rel) %>%
  mutate(group_id = row_number()) %>%
  pivot_longer(
    cols = starts_with("position_"),
    names_to = "t",
    values_to = "position"
  ) %>%
  mutate(t = factor(t, levels = c("position_start", "position_before", "position_after", "position_start_rel", "position_before_rel", "position_after_rel")))

df_control

```


```{r, warning = FALSE}
df_control %>%   
  filter(grepl('_rel', t)) %>% 
  ggplot(mapping = aes(x = t, y = position, group = group_id, colour = team_name)) +
    geom_point() +
    geom_line() +
    geom_smooth(formula = y ~ x, method = "loess", mapping = aes(group = NA)) +
    labs(title = "Change of position, pre and post manager change")
```

marriage

```{r}
names(df_control)
```

```{r}
names(df_treatments)
```

```{r}
df_control$treatment <- 0
df_treatments$treatment <- 1

df_did <- rbind(df_control, df_treatments) %>% 
  filter(grepl('_rel', t)) %>% 
  mutate(treatment = factor(treatment, levels = c(0,1), labels = c('Control', 'Treatment')))
df_did
```

## Checking the linear trend assumption

```{r}


df_did %>% 
  group_by(t, treatment) %>% 
  summarize(avg_position = mean(position)) %>% 
  ungroup() %>% 
    ggplot(mapping = aes(x = t, y = avg_position, color=factor(treatment), group = treatment))+
      geom_line(size=1)+
      geom_vline(xintercept=2.1) +
      guides(color = guide_legend(title = element_blank())) +
      labs(title = "Trend comparison of control and treatment group", x = "Time", y = "Position (Relative)")
```

## Calculating the ATET using simple means

```{r}

df_did$post <- as.numeric(df_did$t == "position_after_rel")


(mean(df_did[df_did$treatment=="Treatment" & df_did$post==1,]$position)-
mean(df_did$position[df_did$treatment=="Control" & df_did$post==1]))-
(mean(df_did$position[df_did$treatment=="Treatment" & df_did$post==0])-
mean(df_did$position[df_did$treatment=="Control" & df_did$post==0]))
```
The treatment group seems to be one position weaker than control. 



# Descriptive statistics?

```{r}
did_baseline <- lm(position~post*treatment, data = df_did)
summary(did_baseline)
```


```{r}
did_fe_teams <- feols(fml = position~post*treatment | team_id , data = df_did)
summary(did_fe_teams)
```

# Results

# Conclusion

